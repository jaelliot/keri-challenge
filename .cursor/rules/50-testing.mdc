---
description: Testing standards for KERI implementation (Pytest, Asyncio, Distributed Systems)
globs: ["tests/**/*.py", "**/*_test.py", "**/conftest.py"]
alwaysApply: false
---

## Use when
- Writing or modifying tests for KERI protocols, KEL validation, or CESR parsing.
- Configuring test infrastructure for asynchronous coroutines.
- Simulating distributed network interactions (Witnesses, Watchers).

## Do
- **Framework**: Use `pytest` exclusively.
- **Async Testing**: Use `pytest-asyncio` for all coroutine testing. Mark async tests with `@pytest.mark.asyncio`.
- **KERI Primitives**:
    - **KEL Validation**: Test positive and negative cases for KEL event chains (e.g., broken hash links, invalid signatures, out-of-order events).
    - **CESR**: Verify round-trip serialization/deserialization for all crypto primitives.
    - **Duplicity**: explicitly test "First-Seen" policy logic by injecting competing events.
- **Fixtures**:
    - Use `conftest.py` for shared KERI state (e.g., temporary KEL databases, mock Habitat/Hab).
    - Create fixtures for `Salter`, `Signer`, and `Verfer` key management setup.
    - Use `tmp_path` for file-backed KEL storage tests.
- **Mocking**:
    - Mock network transport (TCP/HTTP) to test protocol logic without actual I/O.
    - Use `hio` (Hierarchical I/O) simulators or similar if using KERI's preferred async stack, or `asyncio.Queue` for local transport simulation.
- **Race Conditions**: Test for race conditions in "First-Seen" logic using concurrent coroutines.

## Don't
- **Live Networks**: Don't rely on public witnesses or ledgers for unit/integration tests.
- **Blocking I/O**: Don't use blocking I/O in async tests; it will freeze the event loop.
- **Hardcoded Crypto**: Don't hardcode full crypto primitives if possible; generate them deterministically in fixtures (using a fixed salt).
- **Ignore State**: Don't assume a clean state unless the fixture explicitly provides it; KELs are append-only and persistent.

## Notes / Examples
- **Async Test Example**:
  ```python
  import pytest
  from keri.core import eventing

  @pytest.mark.asyncio
  async def test_kel_event_verification():
      # Setup
      hab = mock_hab_fixture()
      
      # Execute
      msg = await hab.make_inception()
      
      # Verify
      assert eventing.verify(msg)
  ```
- **Duplicity Testing**:
  "Simulate two witnesses receiving different rotation events for the same sequence number. Verify that the Validator marks the AID as duplicitous."
- **CESR Round-trip**:
  ```python
  def test_cesr_serialization():
      original = create_event()
      serialized = original.qb64
      deserialized = parse(serialized)
      assert original == deserialized
  ```
