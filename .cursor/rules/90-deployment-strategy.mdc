---
description: Standards for deployment environments, parity, and release strategies
globs: ["deploy/**/*.yaml", ".github/workflows/**/*.yaml", "docker-compose*.yml"]
alwaysApply: false
---

## Use when
- Configuring deployment pipelines (CI/CD).
- Setting up or modifying environments (Development, Staging, Production).
- Defining release strategies (Blue/Green, Canary).
- Ensuring environment parity across "1-Click" deployments.

## Do
- **Architecture**:
  - Deploy the standard KERI stack: **KERI Agent/Controller** (Primary Service), **LMDB** (Embedded High-Performance Storage).
  - Use **Docker Compose** for infrastructure definition to support the "1-Click" mission.
- **Environment Parity**: Use the **same Docker images** across all environments (Dev, Staging, Prod).
- **Containers**: Use `python:3.12.10-slim-bookworm` as the base image for all Python services to minimize attack surface.
- **Configuration**:
  - Maintain environment-specific configuration via environment variables (not code).
  - Support **OOBI** (Out-Of-Band Introduction) urls for bootstrapping connections.
- **Automation**: Automate all deployment processes; avoid manual steps.
- **Strategy**: Implement **blue-green deployment** for zero-downtime updates in production, ensuring KEL consistency.
- **Development**:
  - Use local Docker Compose with hot-reload and mounted volumes.
  - Use local ephemeral KELs for testing identity interactions.
- **Staging**:
  - Replicate the production stack (Witness/Watcher topology).
  - Use isolated test data and test AIDs.
- **Production**:
  - Ensure proper resource allocation (CPU/Memory) for cryptographic operations.
  - **Monitoring**: Monitor resource usage (CPU, memory) and KEL integrity.
  - **Storage**: Ensure persistent volumes for LMDB to prevent data loss (Critical for KELs).
  - Enable backup and monitoring.

## Don't
- **Manual Config**: Don't manually configure environments on the server.
- **Docker Compose**: Don't use the `version:` attribute in `docker-compose.yml` files (deprecated).
- **Code Paths**: Don't use environment-specific code paths (e.g., `if env == 'prod': ...`); use configuration injection.
- **Drift**: Don't allow environments to drift significantly in version or configuration structure.
- **Direct Access**: Don't directly modify production resources; go through the deployment pipeline.
- **External Dependencies**: Avoid external message brokers (Redis, RabbitMQ) unless strictly necessary for the "Web" transport layer; prefer `asyncio` internal queues.

## Notes / Examples
- **Stack Components**:
  - **KERI Agent**: Python application handling Key Event Logs (KELs) and AIDs.
  - **LMDB**: Memory-mapped database used for immutable event storage.
  - **Witnesses**: Optional sidecars or external services for validation.
- **Blue-Green Deployment**: Spin up the new version (Green) alongside the old (Blue), verify health, then switch traffic. Ensure KEL locks are managed if sharing storage.
- **Environment Parity**: The image built in CI is the exact image running in Production.
- **Infrastructure**: Preference for container-native platforms (AWS ECS, Kubernetes) but support "1-Click" local deployment.
